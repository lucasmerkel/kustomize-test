const cds = require('../cds')

const { getCompilerError } = require('./utils')

const validateCsn = (csn, req) => {
  if (!csn) req.reject(400, 'Missing extension')
  if (!csn.extensions) return

  csn.extensions.forEach(extension => {
    if (!extension.extend || !cds.model.definitions[extension.extend]) {
      req.reject(400, 'Invalid extension. Parameter "extend" missing or malformed')
    }

    if (!extension.elements) {
      req.reject(400, 'Invalid extension. Missing parameter "elements"')
    }
  })
}

const validateExtensionFields = (csn, req) => {
  if (!csn.extensions) return

  csn.extensions.forEach(extension => {
    if (extension.elements) {
      Object.keys(extension.elements).forEach(name => {
        if (!/^[A-Za-z]\w*$/.test(name)) {
          req.reject(400, `Invalid extension. Bad element name "${name}"`)
        }

        if (Object.keys(cds.model.definitions[extension.extend].elements).includes(name)) {
          req.reject(400, `Invalid extension. Element "${name}" already exists`)
        }
      })
    }
  })
}

const validateExtension = async (ext, tenant, req) => {
  try {
    const { 'cds.xt.ModelProviderService': mps } = cds.services
    const csn = await mps.getCsn(tenant, ['*'])
    const extCsn = cds.compile.to.json(ext)
    await cds.compile.to.csn({ 'base.csn': JSON.stringify(csn), 'ext.csn': extCsn })
  } catch (err) {
    req.reject(400, getCompilerError(err.messages))
  }
}

module.exports = {
  validateCsn,
  validateExtensionFields,
  validateExtension
}
