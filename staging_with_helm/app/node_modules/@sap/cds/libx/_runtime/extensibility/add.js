const cds = require('../cds')

const { validateExtension } = require('./validation')
const handleDefaults = require('./defaults')
const activateExt = require('./activate')

const _isCSN = str => str.substring(0, 1) === '{'

const add = async function (req) {
  let { extension, tag, activate } = req.data
  if (!extension || !extension.length) req.reject(400, 'Missing extension')
  if (!activate) activate = 'database'
  if (!tag) tag = null
  const tenant = req.tenant || (req.user.is('internal-user') && req.data.tenant)

  const csn = _isCSN(extension) ? JSON.parse(extension) : cds.parse.cdl(extension)
  if (csn.requires) delete csn.requires
  await validateExtension(csn, tenant, req)

  const ID = cds.utils.uuid()
  await cds.tx({ tenant }, async tx => {
    await tx.run(INSERT.into('cds.xt.Extensions').entries([{ ID, tag, csn: JSON.stringify(csn), activated: activate }]))
    if (activate === 'propertyBag' && csn.extensions) csn.extensions.forEach(async ext => await handleDefaults(ext, tx))
  })

  if (activate === 'database') {
    await activateExt(ID, tag, tenant)
  }
}

const promote = async function (req) {
  let { tag, activate } = req.data
  if (!activate) activate = 'database'
  if (!tag) tag = null
  const tenant = req.tenant || (req.user.is('internal-user') && req.data.tenant) || ''
  if (activate !== 'database') req.reject(400, 'Promote to propertyBag is not supported')

  await activateExt(null, tag, tenant)
}

module.exports = { add, promote }
